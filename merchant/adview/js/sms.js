var LSM=LSM||{};LSM.smsCheckContent=function(){var t,e=$("#J_sms_content"),n=($("#J_check_btn"),$("#J_sms_status"));this.postCheckContent=function(s){s.preventDefault(),n.hide(),clearTimeout(t);var i=this,a=e.val();0!=a.length&&$.ajax({type:"GET",url:"https://sms-my.luosimao.com/send/check_msg",data:{msg:a},success:function(t){i.statusCheckContent(t)}})},this.statusCheckContent=function(t){t&&t.error==-2?(n.html("检测未通过！"+t.msg).show(),n.prop("class","label radius alert")):t&&0==t.error&&(n.html("检测通过").show(),n.prop("class","label radius success")),this.hideCheckContent()},this.hideCheckContent=function(){t=setTimeout(function(){n.fadeOut()},5e3)},$(document).on("click","#J_check_btn",$.proxy(this.postCheckContent,this))},LSM.submitSend=function(){var t,e,n,s,i=$("#J_signature_txt"),a=$("#J_mobile_list"),o=$("#J_message_content"),l=$("#sms-submit"),r=$("#J_message_error"),c=$("#sms-submit-success"),u=$("#sms-send-tips"),d=$("#sms-submit-tips"),m=$("#toggle_send_time"),h=$("#J_send_time"),p=$("#J_word_count"),f=0;this.checkMessageBlank=function(s){return s.preventDefault(),t=$.trim(i.val()),e=$.trim(a.val()),n=$.trim(o.val()),""==t?void this.showSendError("请输入短信签名"):""==e?void this.showSendError("请输入需要发送的手机号码"):""==n?void this.showSendError("请输入需要发送的短信内容"):i.val().length+o.val().length>300?void this.showSendError("短信字数超过300字,请返回修改"):(LSM.getTipsOpen(),void this.hideSendError())},this.getTipsOpen=function(){var t=$.trim(a.val()).split("\n").length;d.find(".send-message-txt").html($.trim(o.val())+$.trim(i.val())),d.find(".number-total").html(p.html()),d.find(".phone-number-total").html(t),1==m.attr("data-check")?(d.find(".timestamp-field").show(),d.find(".timestamp").html(h.val())):(d.find(".timestamp-field").hide(),d.find(".timestamp").html("")),t>1e3&&d.find(".phone-number-long").show(),d.foundation("reveal","open")},this.showSendError=function(t){return r.html(t),r.show()},this.hideSendError=function(){return r.hide()},this.postSend=function(i){if(i.preventDefault(),0!==f)return 0;f=1,u.append('<span class="fa fa-refresh fa-spin"></span>');var a=this,o="";s&&(o=s);var l={msg:n+t,mobile_list:e,sign:t};1==$("#toggle_send_time").attr("data-check")&&(l.spec_time=$("#J_send_time").val()),$.ajax({type:"POST",url:"https://sms-my.luosimao.com/send/batch",data:l,success:function(t){t&&(a.getSendResult(t),f=0,u.find(".fa").remove())},error:function(){alert("很抱歉,提交出现错误,请刷新页面后重试"),f=0,u.find(".fa").remove()}})},this.getSendResult=function(t){0!==t.error?(this.showSendError(t.msg),d.foundation("reveal","close")):0==t.error&&(c.find(".num-all").html(t.send),c.find(".num-wrong").html(t.error_mobile_num),c.find(".num-repeat").html(t.repeat_mobile_num),c.find(".num-last").html(t.deposit),c.find(".num-black").html(t.black_mobile_num),c.foundation("reveal","open"))},this.resetResult=function(t){t.preventDefault(),window.location.reload()},c.on("close.fndtn.reveal","[data-reveal]",function(){window.location.reload()}),this.closeTips=function(t){t.preventDefault(),d.foundation("reveal","close"),f=0,u.find(".fa").remove()},c.on("click",".reload_send",$.proxy(this.resetResult,this)),l.on("click",$.proxy(this.checkMessageBlank,this)),d.on("click","#sms-send-back",$.proxy(this.closeTips,this)),u.on("click",$.proxy(this.postSend,this))},LSM.apiKey=function(){this.toggleKey=function(t){t.preventDefault();var e=$(t.currentTarget),n=$("#api-key");n.is(":visible")?(n.hide(),e.html("显示 API KEY")):(n.show(),e.html("隐藏 API KEY"))},this.rebuildKey=function(t){t.preventDefault();var e=$("#api-key");confirm("您即将修改 API KEY，请注意及时替换程序代码中的KEY，避免服务受到影响！")&&$.ajax({type:"GET",url:"https://sms-my.luosimao.com/api/change_api_key",success:function(t){0==t.error&&e.html(t.code),e.is(":hidden")&&$(".toggle-key").trigger("click")}})},$(document).on("click",".toggle-key",$.proxy(this.toggleKey,this)),$(document).on("click",".rebuild-key",$.proxy(this.rebuildKey,this))},LSM.messageCheck=function(){var t=$("#J_message_check"),e=$("#J_message_content");this.sendCheck=function(t){t.preventDefault();var n=$.trim(e.val());return 0==n.length?void e.focus():void $.ajax({type:"GET",url:"https://sms-my.luosimao.com/send/check_msg",data:{msg:n},success:function(t){t&&LSM.showMessageCheck(t)}})},this.showMessageCheck=function(t){var e=$("#J_check_result");t.error==-2?(e.html("检测未通过！"+t.msg).show(),e.attr("class","label radius alert")):0==t.error&&(e.html("恭喜！检测通过！").show(),e.attr("class","label radius success"))},t.on("click",$.proxy(this.sendCheck,this))},LSM.smsContent=function(){var t=$("#J_message_content"),e=$("#J_word_count"),n=$("#J_signature_txt"),s=function(){i();var s=t.val(),a=s.length+n.val().length;if(a<=67)e.html("长度为<b>"+a+"</b>个字（含签名），按<b>1</b>条计费");else if(a>300)e.html("长度超过了<b>300</b>字,请修改");else{var o=Math.ceil(a/67);e.html("长度为<b>"+a+"</b>个字（含签名），按<b>"+o+"</b>条计费")}},i=function(){e.is("visible")||(""==t.val()?e.hide():e.show())};t.on("keyup blur focus propertychange",function(){s()}),n.on("change",function(){s()}),this.calculateInit=function(){0!==$("#J_signature_txt").length&&s()},this.calculateInit()},LSM.setSendTime=function(){var t=$(".send-time");if(t.length){var e=($(".send-time-inner"),t.find(".send-time-result strong")),n=$("<option></option>"),s=$("#J_send_time"),i=t.find(".fancy-select");this.setTime=function(){i.trigger("update");var t=$("#sms-send-year").val(),n=$("#sms-send-month").val(),a=$("#sms-send-day").val(),o=$("#sms-send-hour").val(),l=$("#sms-send-minute").val();e.html(t+"年"+n+"月"+a+"日"+o+"时"+l+"分"),s.val(t+"-"+n+"-"+a+" "+o+":"+l),s.attr("data-timeVali",n+"-"+a+"-"+t+" "+o+":"+l+":00")},this.timeInit=function(){this.setMonth(),this.setDay(),i.fancySelect();var t=new Date,e=this.suitNumber(t.getFullYear()),n=this.suitNumber(t.getMonth()+1),s=this.suitNumber(t.getDate()),a=this.suitNumber(t.getHours()),o=this.suitNumber(t.getMinutes());$("#sms-send-year option[value="+e+"]").prop("selected",!0),$("#sms-send-month option[value="+n+"]").prop("selected",!0),$("#sms-send-day option[value="+s+"]").prop("selected",!0),$("#sms-send-hour option[value="+a+"]").prop("selected",!0),$("#sms-send-minute option[value="+o+"]").prop("selected",!0),this.setTime()},this.switchTime=function(t){$(t.currentTarget);this.setTime()},this.toggleTime=function(e){e.preventDefault();var n=$(e.currentTarget);t.is(":hidden")?(t.show(),n.html("关闭定时发送").attr("data-check",1)):(t.hide(),n.html("启用定时发送").attr("data-check",0))},this.suitNumber=function(t){var e;return e=t<10?"0"+t:t},this.setMonth=function(){var t,e=$("#sms-send-month");e.html("");for(var s=1;s<=12;s++)t=this.suitNumber(s),n.clone().text(t).attr("value",t).appendTo(e)},this.getMonth=function(){var t,e=$("#send_year").val();return t=e%4==0&&e%100!=0||e%400==0?[31,29,31,30,31,30,31,31,30,31,30,31]:[31,28,31,30,31,30,31,31,30,31,30,31]},this.setDay=function(){var t,e=$("#sms-send-month").val(),s=this.getMonth()[e-1],i=$("#sms-send-day"),a=i.val();i.html("");for(var o=1;o<=s;o++)t=this.suitNumber(o),n.clone().html(t).attr("value",t).appendTo(i);a>s?i.find("option:last").attr("selected",!0):i.val(a)},this.timeInit(),i.on("change.fs",$.proxy(this.switchTime,this)),$(document).on("click","#toggle_send_time",$.proxy(this.toggleTime,this)),t.on("change.fs","#sms-send-month",$.proxy(this.setDay,this))}},LSM.uploadMobileList=function(){var t=$("#file_upload"),e=this;this.insertMobileList=function(t){if(t){for(var e,n=$("#J_mobile_list"),s=n.val(),i=$.parseJSON(t).mobile_list,a=0;a<i.length;a++)e=""==s?"":"\n",s=s+e+i[a];n.val(s).trigger("focus")}},t.length&&t.uploadifive({buttonText:"选择文件并导入",buttonClass:"button radius tiny",method:"post",fileObjName:"upload_file",uploadScript:"https://sms-my.luosimao.com/send/import_mobile",formData:{uploading:1},height:"",width:"",onUploadComplete:function(t,n){e.insertMobileList(n)}})},LSM.smsCharts=function(t,e){if(t||e){var n=this;this.sliceDate=function(t,e){if(!t||!e)return!1;for(var n=[],s=0;s<e.length;s++)"x"==t&&n.push(e[s].x),"y"==t&&n.push(Number(e[s].y));return n};var s=echarts.init(document.getElementById("sms-send-chart")),i={title:{text:current_month,x:"center",textStyle:{fontSize:18,color:"#3e4d60"}},grid:{left:"3%",right:"4%",bottom:"3%",containLabel:!0},tooltip:{trigger:"axis",axisPointer:{lineStyle:{color:"#CCC"}},textStyle:{fontSize:12}},xAxis:{type:"category",data:n.sliceDate("x",t),axisLine:{lineStyle:{color:"#F0F0F0"}},axisTick:{lineStyle:{color:"#F0F0F0"}},splitLine:{lineStyle:{color:"#E9E9E9"}},axisLabel:{textStyle:{color:"#999"}}},yAxis:{axisLine:{lineStyle:{color:"#F0F0F0"}},axisTick:{lineStyle:{color:"#F0F0F0"}},splitLine:{lineStyle:{color:"#E9E9E9"}},axisLabel:{textStyle:{color:"#999"}}},series:[{name:"总发送量",type:"line",areaStyle:{normal:{color:"#eef8ff"}},data:n.sliceDate("y",t),lineStyle:{normal:{color:"#5ab8ff"}},smooth:!0}]};s.setOption(i)}},LSM.sendHistory=function(){var t=$(".send-history");0!=t.length&&(this.cancelSend=function(t){t.preventDefault();var e=$(t.currentTarget);confirm("确认要取消本次发送？")&&(window.location.href=e.attr("href"))},t.on("click",".cancel-send",$.proxy(this.cancelSend,this)))},LSM.smsPush=function(){var t=$("#sms-push-setting");if(!t.length)return 0;var e=$("#push-setting-btn"),n=$("#push-setting-url"),s=t.find(".push-setting-status"),i=$("#push_btn"),a=$("#push_url"),o=t.find(".setting-status");e.on("click",function(t){return t.preventDefault(),s.html(""),s.attr("class","push-setting-status"),0==n.val().length?(s.attr("class","push-setting-status label radius tiny alert"),s.html("请输入URL,示例:http://127.0.0.1/receive"),0):void $.ajax({type:"POST",url:"/send/push_test",data:{status_push_url:n.val()},success:function(t){t.error==-1&&(s.attr("class","push-setting-status label radius tiny alert"),s.html("URL格式错误,请填写正确的URL,示例:http://127.0.0.1/receive")),0==t.error&&(s.attr("class","push-setting-status label radius tiny success"),s.html("测试数据发送成功"))}})}),i.on("click",function(t){return t.preventDefault(),o.html(""),o.attr("class","setting-status"),0==a.val().length?(o.attr("class","setting-status label radius tiny alert"),o.html("请输入URL,示例:http://127.0.0.1/receive"),0):void $.ajax({type:"POST",url:"/send/push_test",data:{mo_push_url:a.val()},success:function(t){t.error==-1&&(o.attr("class","setting-status label radius tiny alert"),o.html("URL格式错误,请填写正确的URL,示例:http://127.0.0.1/receive")),0==t.error&&(o.attr("class","setting-status label radius tiny success"),o.html("测试数据发送成功"))}})})},LSM.smsTemplate=function(){var t=$("#sms-template-add"),e=$("#sms-template-add-success"),n=$("#sms-template-test");if(!t.length)return 0;var s=t.find(".result"),i=n.find(".result"),a=n.find(".template-test-result"),o=$(".sms-template-list");t.on("click",".template-submit",function(n){n.preventDefault(),s.html("");var i=t.find(".template-content");if(0==i.val().length)return s.html("请输入短信内容"),0;var a=i.val(),o=t.find(".sms-sign-value");if(o.length>0){if(0==o.val().length)return s.html("请选择签名"),0;a+=o.val()}$.ajax({type:"POST",url:"/template/add",data:{message:a},success:function(t){t.error!=-2&&t.error!=-1||s.html(t.msg),0==t.error&&e.foundation("reveal","open")}})}),e.on("click",".close-window",function(t){t.preventDefault(),e.foundation("reveal","close")}),$(document).on("closed.fndtn.reveal","#sms-template-add[data-reveal]",function(){t.find(".template-content").val(""),t.find(".result").html("")}),$(document).on("closed.fndtn.reveal","#sms-template-add-success[data-reveal]",function(){window.location.reload()}),$(document).on("closed.fndtn.reveal","#sms-template-test[data-reveal]",function(){n.find(".match-content").val(""),n.find(".result").html(""),a.hide(),a.find(".test-result-list").html("")});var l='{{#data}}<li><div class="list-hd"><span class="right label radius">已生效</span>#{{no}}</div><div class="list-bd">{{message}}</div></li>{{/data}}';n.on("click",".match-submit",function(t){t.preventDefault(),i.html(""),a.hide(),a.find(".test-result-list").html("");var e=n.find(".match-content");return 0==e.val().length?(i.html("请输入短信内容"),0):void $.ajax({type:"POST",url:"/template/match",data:{message:e.val()},success:function(t){var e=t.res;if(0==e.length&&i.html("暂无任何符合的模型,请添加此内容为新的模板"),e.length>0){a.show();for(var n=0;n<e.length;n++){Mustache.parse(l);var s=Mustache.render(l,{data:e[n]});a.find(".test-result-list").append(s)}}}})}),o.on("click",".template-delete",function(t){if(t.preventDefault(),!confirm("确认删除此模板,此操作不可恢复"))return 0;var e=$(this).attr("data-id");$.ajax({type:"GET",url:"/template/delete/"+e,success:function(t){0==t.error&&window.location.reload()}})}),o.find(".back-reason").length>0&&$(".back-reason").tooltipster({animation:"fade",position:"top"})},LSM.blackList=function(){var t=$("#sms-black-add");if(!t.length)return 0;var e=t.find(".result"),n=t.find(".mobile"),s=t.find(".summary"),i=$(".sms-black-list");t.on("click",".black-submit",function(t){if(t.preventDefault(),e.html(""),0==n.val().length)return e.html("请输入手机号码"),!1;if(!/^1[3-9]\d{9}$/.test(n.val()))return e.html("请输入正确的手机号码"),!1;var i={mobile:n.val(),memo:s.val()};$.ajax({type:"POST",url:"/black_list/add",data:i,success:function(t){0!==t.error?e.html(t.msg):window.location.reload()}})}),$(document).on("closed.fndtn.reveal","#sms-black-add[data-reveal]",function(){e.html(""),n.val(""),s.val("")}),i.on("click",".black-delete",function(t){if(t.preventDefault(),!confirm("您即将删除黑名单,此操作不可恢复"))return!1;var e=$(this).attr("data-id");return!!e&&void $.ajax({type:"GET",url:"/black_list/delete/"+e,success:function(t){0==t.error&&window.location.reload()}})})},LSM.topMenu=function(){var t=$("#drop-header-member");if(!t.length)return 0;var e=t.find(".username"),n=t.find(".email"),s=t.find(".phone"),i=t.find(".sms-deposit"),a=t.find(".voice-deposit"),o=t.find(".email-deposit");$.ajax({type:"GET",url:"https://my.luosimao.com/api/account_info",dataType:"jsonp",jsonp:"cb",success:function(t){var l=t.res;e.html(l.username),n.html(l.email),s.html(l.mobile),i.html(l.sms_deposit),a.html(l.voice_deposit),o.html(l.mail_deposit)}})},LSM.signatureManage=function(){var t=$("#sms-signature-add");if(!t.length)return 0;var e=t.find(".content"),n=t.find(".signature-submit"),s=t.find(".result"),i=$("#sms-signature-add-btn"),a=$("#sms-signature-add-success"),o=$(".signature-table");i.on("click",function(e){e.preventDefault(),t.foundation("reveal","open")}),n.on("click",function(t){return t.preventDefault(),0==e.val().length?(s.html("请输入签名"),0):e.val().length<2?(s.html("签名至少需要2个字符"),0):void $.ajax({type:"POST",url:"/signature/add",data:{sign:e.val()},success:function(t){0==t.error&&(e.val(""),s.html(""),a.foundation("reveal","open"))}})}),$(document).on("closed.fndtn.reveal","#sms-signature-add-success[data-reveal]",function(){window.location.reload()}),$(document).on("closed.fndtn.reveal","#sms-signature-add[data-reveal]",function(){e.val(""),s.html("")}),a.on("click",".close-window",function(t){t.preventDefault(),a.foundation("reveal","close")}),o.on("click",".delete",function(t){t.preventDefault(),confirm("确认要删除此签名?此操作不可恢复")&&(window.location=$(this).attr("href"))})},$(function(){$(document).foundation(),LSM.topMenu(),LSM.smsCheckContent(),LSM.apiKey(),LSM.submitSend(),LSM.messageCheck(),LSM.setSendTime(),LSM.uploadMobileList(),LSM.smsContent(),LSM.sendHistory(),LSM.smsPush(),LSM.smsTemplate(),LSM.blackList(),LSM.signatureManage(),"undefined"!=typeof success&&LSM.smsCharts(success),function(){var t=$(".fancy-select");t.length&&t.fancySelect()}(),function(){var t=$("#J_mobile_list");t.length&&t.linenumbers({col_width:"90px"})}(),function(){var t=$(".footable");t.length&&t.footable()}(),function(){var t=$("#toggle-sort");if(t.length){var e=$("#upgrade-sort");t.on("click",function(t){t.preventDefault(),e.toggle()})}}(),function(){function t(t){var e=new Date,n=e.getTime()-864e5,s=new Date(n-24*t*60*60*1e3);return s}var e=$("#fdatepicker");e.length&&(currentDay&&e.attr("data-date",currentDay),e.fdatepicker({format:"yyyy-mm-dd",startDate:t(180),endDate:t(-1)}),e.on("changeDate",function(t){var n=e.data("date").replace(/-/g,"");window.location.href="https://sms-my.luosimao.com/send/history/"+n+"/all/all"}))}(),function(){var t=$("#fdatepicker-incoming");t.length&&(currentDay&&t.attr("data-date",currentDay),t.fdatepicker({format:"yyyy-mm-dd"}),t.on("changeDate",function(e){var n=t.data("date").replace(/-/g,"");window.location.href="https://sms-my.luosimao.com/incoming/index/"+n}))}(),function(){var t=$("#VoiceDatepicker");t.length&&(currentDay&&t.attr("data-date",currentDay),t.fdatepicker({format:"yyyy-mm-dd"}),t.on("changeDate",function(e){var n=t.data("date").replace(/-/g,"");window.location.href="https://voice-my.luosimao.com/send/history/"+n}))}(),function(){var t=$("#smsDateChange");t.length&&t.on("change.fs",function(){window.location.href="https://sms-my.luosimao.com/send/statistics/"+this.value})}(),function(){var t=$(".l-tooltips");t.length&&t.tooltipster({animation:"fade",theme:"tooltipster-light",content:$('<p>状态说明:</p><p><span class="label success radius">DELIVRD</span> 短信成功接收</p><p><span class="label info radius">UNDELIV</span> 短信接收失败: 黑名单、空号、停机、长时间关机等</p><p><span class="label secondary radius">UNKNOWN</span> 短信状态暂未返回: 正在发送暂未返回、信号不良关机造成的延迟投递</p>'),position:"top"})}(),function(){var t=$(".s-tooltips");t.length&&t.tooltipster({animation:"fade",theme:"tooltipster-light",content:$('<p>状态说明:</p><p><span class="label success secondary radius">待审核</span> 短信正等待客服审核</p><p><span class="label radius">发送中</span> 短信正在向运营商网关进行提交</p><p><span class="label success radius">已发送</span> 短信已成功提交至运营商网关</p>'),position:"top"})}(),function(){var t=$(".c-tooltips");t.length&&t.tooltipster({animation:"fade",theme:"tooltipster-light",content:$("<p>短信每67个字计费1条,中英文标点符号均占一个字</p>"),position:"top"})}(),function(){var t=$(".sms-sign-tooltip");return t.length?void t.tooltipster({animation:"fade",theme:"tooltipster-light",content:$("<p>扩展码说明</p><p>1. 扩展码显示在发送的短信号码结尾处</p><p>2. 一个签名对应一个唯一的扩展码</p>"),position:"top"}):0}(),function(){var t=$("#sms-sign-tooltip");return t.length?void t.tooltipster({animation:"fade",theme:"tooltipster-light",content:$("<p>签名注意事项</p><p>1.根据中国基础运营商规定,每条短信必需添加签名</p><p>2.签名格式为中文括号3-7个汉字：例如：【铁壳科技】</p><p>3.签名会自动添加在短信的开头</p><p>4.签名也会占用短信字数,请注意短信长度</p>"),position:"top"}):0}(),function(){var t=$(".sms-sign-system");return t.length?void t.tooltipster({animation:"fade",theme:"tooltipster-light",content:$("<p>此列表内的签名可以直接使用,仅用于测试</p>"),position:"top"}):0}(),function(){var t=$(".sign-back-tooltip");return t.length?void t.tooltipster({animation:"fade",theme:"tooltipster-light",contentAsHTML:!0,position:"top"}):0}(),function(){var t=$("#sms-template-add-btn");if(!t.length)return 0;var e=$("#sms-template-add"),n=$("#sms-template-test-btn"),s=$("#sms-template-test");t.on("click",function(t){t.preventDefault(),e.foundation("reveal","open")}),n.on("click",function(t){t.preventDefault(),s.foundation("reveal","open")})}(),function(){var t=$("#sms-black-add-btn");if(!t.length)return 0;var e=$("#sms-black-add");t.on("click",function(t){t.preventDefault(),e.foundation("reveal","open")})}()});